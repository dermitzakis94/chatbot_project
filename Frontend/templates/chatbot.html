<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>AI Assistant Chatbot</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      height: 100vh; display:flex; justify-content:center; align-items:center;
    }
    .chatbot-container {
      width: 90%; max-width: 800px; height: 90vh; background:#fff;
      border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,.1);
      display:flex; flex-direction:column; overflow:hidden;
    }
    .chatbot-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; padding:20px; text-align:center; position:relative;
    }
    .chatbot-header h1 { font-size:1.5rem; font-weight:600 }
    .chatbot-header .status { font-size:.9rem; opacity:.9; margin-top:5px }
    .session-info { position:absolute; top:10px; right:20px; font-size:.8rem; opacity:.7 }

    .chat-messages {
      flex:1; overflow-y:auto; padding:20px; background:#f8f9fa; scroll-behavior:smooth;
    }
    .message { display:flex; margin-bottom:20px; animation:fadeInUp .3s ease-out }
    .message.user { justify-content:flex-end }
    .message.bot { justify-content:flex-start }
    .message-content { max-width:70%; padding:15px 20px; border-radius:20px; position:relative; word-wrap:break-word }
    .message.user .message-content {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; border-bottom-right-radius:5px;
    }
    .message.bot .message-content {
      background:#fff; color:#333; border:1px solid #e0e0e0; border-bottom-left-radius:5px;
      box-shadow: 0 2px 5px rgba(0,0,0,.06);
    }
    .message-avatar {
      width:40px; height:40px; border-radius:50%; margin:0 10px; display:flex; align-items:center; justify-content:center;
      font-weight:bold; color:#fff; flex-shrink:0;
    }
    .message.user .message-avatar { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); order:1 }
    .message.bot .message-avatar { background: linear-gradient(135deg, #36d1dc 0%, #5b86e5 100%) }

    .chat-input-container { padding:20px; background:#fff; border-top:1px solid #e0e0e0 }
    .chat-input-form { display:flex; gap:10px; align-items:flex-end }
    .chat-input {
      flex:1; padding:15px; border:2px solid #e0e0e0; border-radius:25px; font-size:16px; outline:none;
      transition:border-color .3s; resize:none; max-height:120px; min-height:50px;
    }
    .chat-input:focus { border-color:#667eea }
    .send-button {
      width:50px; height:50px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color:#fff; border:none; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center;
      transition:transform .2s; font-size:20px;
    }
    .send-button:hover { transform:scale(1.05) }
    .send-button:disabled { opacity:.5; cursor:not-allowed; transform:none }

    .typing-indicator {
      display:none; align-items:center; padding:15px 20px; background:#fff; border-radius:20px; border-bottom-left-radius:5px;
      margin:0 10px; box-shadow: 0 2px 5px rgba(0,0,0,.06); border:1px solid #e0e0e0; max-width:70%;
    }
    .typing-dots { display:flex; gap:3px }
    .typing-dot { width:8px; height:8px; border-radius:50%; background:#667eea; animation:typingAnimation 1.4s infinite ease-in-out }
    .typing-dot:nth-child(2){ animation-delay:.2s } .typing-dot:nth-child(3){ animation-delay:.4s }

    .error-message { color:#e74c3c; text-align:center; padding:10px; background:#ffeaea; border-radius:10px; margin:10px }
    .welcome-message { text-align:center; color:#666; padding:40px 20px; background:#fff; border-radius:15px; margin:20px;
      box-shadow:0 2px 10px rgba(0,0,0,.06); display:none; /* Î±ÏÏ‡Î¹ÎºÎ¬ ÎºÏÏ…Ï†ÏŒ */ }

    @keyframes fadeInUp { from{opacity:0; transform:translateY(20px)} to{opacity:1; transform:translateY(0)} }
    @keyframes typingAnimation { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-10px)} }

    @media (max-width:768px){
      .chatbot-container{ width:100%; height:100vh; border-radius:0 }
      .message-content{ max-width:85% }
    }
  </style>
</head>
<body>
  <div class="chatbot-container">
    <div class="chatbot-header">
      <h1 id="companyTitle">ğŸ¤– AI Assistant</h1>
      <div class="status" id="companySubtitle">Î•Î¾Î±Ï„Î¿Î¼Î¹ÎºÎµÏ…Î¼Î­Î½Î¿Ï‚ Î²Î¿Î·Î¸ÏŒÏ‚ - ÎˆÏ„Î¿Î¹Î¼Î¿Ï‚ Î½Î± Î²Î¿Î·Î¸Î®ÏƒÏ‰</div>
      <div class="session-info">Session: <span id="sessionId"></span></div>
    </div>

    <div class="chat-messages" id="chatMessages">
      <div class="welcome-message" id="welcome">
        <h3>ğŸ‘‹ ÎšÎ±Î»ÏÏ‚ Î®ÏÎ¸Î±Ï„Îµ!</h3>
        <p>Î£Ï„ÎµÎ¯Î»Ï„Îµ Î¼Î¿Ï… Î­Î½Î± Î¼Î®Î½Ï…Î¼Î± Î³Î¹Î± Î½Î± Î¾ÎµÎºÎ¹Î½Î®ÏƒÎ¿Ï…Î¼Îµ.</p>
      </div>
    </div>

    <div class="chat-input-container">
      <form class="chat-input-form" id="chatForm">
        <textarea class="chat-input" id="messageInput" placeholder="Î“ÏÎ¬ÏˆÏ„Îµ Ï„Î¿ Î¼Î®Î½Ï…Î¼Î¬ ÏƒÎ±Ï‚ ÎµÎ´Ï..." rows="1" maxlength="2000"></textarea>
        <button type="submit" class="send-button" id="sendButton">â¤</button>
      </form>
    </div>
  </div>

  <script>
    class Chatbot {
      constructor() {
        this.apiUrl = '/chat';
        this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).slice(2,8);
        this.websiteData = {};       // â† ÎµÎ´Ï Î¸Î± Î¼Ï€Î¿Ï…Î½ Ï„Î± scraped
        this.companyInfo = {};       // â† ÎµÎ´Ï Î¸Î± Î¼Ï€Î¿Ï…Î½ companyName/industry/greeting/endMessage
        this.evaluationContext = {}; // Ï€.Ï‡. { include_full_html:false }
        this.hasGreeted = false;     // â† ÎÎ•ÎŸ: flag Î³Î¹Î± Ï„Î¿Î½ Ï‡Î±Î¹ÏÎµÏ„Î¹ÏƒÎ¼ÏŒ

        this.chatMessages = document.getElementById('chatMessages');
        this.messageInput = document.getElementById('messageInput');
        this.sendButton = document.getElementById('sendButton');
        this.chatForm = document.getElementById('chatForm');
        this.sessionIdElement = document.getElementById('sessionId');
        this.companyTitle = document.getElementById('companyTitle');
        this.companySubtitle = document.getElementById('companySubtitle');

        this.sessionIdElement.textContent = this.sessionId.slice(0,12) + 'â€¦';
        this.attachEvents();
      }

      attachEvents() {
        this.chatForm.addEventListener('submit', (e)=> this.handleSubmit(e));
        this.messageInput.addEventListener('keydown', (e)=>{
          if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); this.handleSubmit(e); }
        });
        this.messageInput.addEventListener('input', ()=> this.adjustTextarea());
      }

      adjustTextarea() {
        this.messageInput.style.height = 'auto';
        this.messageInput.style.height = Math.min(this.messageInput.scrollHeight, 120) + 'px';
      }

      // ÎÎ•Î‘ ÎœÎ•Î˜ÎŸÎ”ÎŸÎ£: Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î¿Ï‚ Ï‡Î±Î¹ÏÎµÏ„Î¹ÏƒÎ¼ÏŒÏ‚
      async sendAutomaticGreeting() {
        if (this.hasGreeted) return; // ÎœÏŒÎ½Î¿ Î¼Î¯Î± Ï†Î¿ÏÎ¬
        
        this.hasGreeted = true;
        const greeting = this.companyInfo.greeting || 'Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î ÏÏ‚ Î¼Ï€Î¿ÏÏ Î½Î± Î²Î¿Î·Î¸Î®ÏƒÏ‰;';
        
        // Î ÏÎ¿ÏƒÎ¿Î¼Î¿Î¹ÏÎ½Î¿Ï…Î¼Îµ Î¼Î¹ÎºÏÎ® ÎºÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ· Î³Î¹Î± Ï†Ï…ÏƒÎ¹ÎºÏŒÏ„Î·Ï„Î±
        this.showTypingIndicator();
        
        setTimeout(() => {
          this.hideTypingIndicator();
          this.addMessage(greeting, 'bot');
        }, 1500); // 1.5 Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î± "ÏƒÎºÎ­ÏˆÎ·Ï‚"
      }

      async handleSubmit(e) {
        e.preventDefault();
        const message = (this.messageInput.value || '').trim();
        if (!message) return;
        
        this.addMessage(message, 'user');
        this.messageInput.value = ''; 
        this.adjustTextarea();
        this.setLoading(true);

        try {
          const res = await this.sendMessage(message);
          this.hideTypingIndicator();
          this.addMessage(res.answer || '(Ï‡Ï‰ÏÎ¯Ï‚ Î±Ï€Î¬Î½Ï„Î·ÏƒÎ·)', 'bot');
        } catch (err) {
          console.error('Chat error:', err);
          this.hideTypingIndicator();
          this.showError('Î£Ï…Î³Î³Î½ÏÎ¼Î·, Ï€ÏÎ¿Î­ÎºÏ…ÏˆÎµ ÏƒÏ†Î¬Î»Î¼Î±. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.');
        } finally {
          this.setLoading(false);
        }
      }

      async sendMessage(message) {
        const requestData = {
          session_id: this.sessionId,
          question: message,
          website_data: this.websiteData,
          company_info: this.companyInfo,
          evaluation_context: this.evaluationContext
        };

        console.log('â¡ï¸ /chat payload:', {
          companyName: requestData.company_info?.companyName,
          industry: requestData.company_info?.industry,
          greeting: !!requestData.company_info?.greeting,
          endMessage: !!requestData.company_info?.endMessage,
          text_len: (requestData.website_data?.text || '').length,
          links: (requestData.website_data?.links || []).length
        });

        const resp = await fetch(this.apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData)
        });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        return await resp.json();
      }

      setCompanyInfo(info) {
        this.companyInfo = { ...this.companyInfo, ...info };
        if (this.companyInfo.name) {
          this.companyTitle.innerHTML = `ğŸ¢ ${this.companyInfo.name}`;
        }
        if (this.companyInfo.description) {
          this.companySubtitle.textContent = `${this.companyInfo.description} - ÎˆÏ„Î¿Î¹Î¼Î¿Ï‚ Î½Î± Î²Î¿Î·Î¸Î®ÏƒÏ‰`;
        }
        
        // ÎÎ•ÎŸ: Î‘Ï†Î¿Ï Ï†Î¿ÏÏ„ÏÏƒÎ¿Ï…Î¼Îµ Ï„Î± ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±, ÏƒÏ„ÎµÎ¯Î»Îµ Ï‡Î±Î¹ÏÎµÏ„Î¹ÏƒÎ¼ÏŒ
        setTimeout(() => this.sendAutomaticGreeting(), 800);
      }

      setWebsiteData(data) { this.websiteData = data || {}; }
      setEvaluationContext(ctx) { this.evaluationContext = ctx || {}; }

      addMessage(content, type) {
        const welcome = document.getElementById('welcome');
        if (welcome) welcome.remove();

        const row = document.createElement('div');
        row.className = `message ${type}`;

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = (type === 'user') ? 'ğŸ‘¤' : 'ğŸ¤–';

        const bubble = document.createElement('div');
        bubble.className = 'message-content';
        bubble.innerHTML = this.formatMessage(content);

        if (type === 'user') { row.appendChild(bubble); row.appendChild(avatar); }
        else { row.appendChild(avatar); row.appendChild(bubble); }

        this.chatMessages.appendChild(row);
        this.scrollToBottom();
      }

      formatMessage(t) {
        return (t || '')
          .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
          .replace(/\n/g,'<br>')
          .replace(/(https?:\/\/[^\s<]+)/g, '<a href="$1" target="_blank" rel="noopener">$1</a>');
      }

      setLoading(loading) {
        this.sendButton.disabled = loading;
        this.messageInput.disabled = loading;
        if (loading) this.showTypingIndicator(); 
        else this.hideTypingIndicator();
      }

      showTypingIndicator() {
        // Î‘Ï†Î±Î¯ÏÎµÏƒÎµ Ï…Ï€Î¬ÏÏ‡Î¿Î½ typing indicator Î±Î½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹
        this.hideTypingIndicator();
        
        const row = document.createElement('div');
        row.className = 'message bot';
        row.id = 'typing-message'; // ÎÎ•ÎŸ: ID Î³Î¹Î± ÎµÏÎºÎ¿Î»Î· Î±Ï†Î±Î¯ÏÎµÏƒÎ·

        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        avatar.textContent = 'ğŸ¤–';

        const ind = document.createElement('div');
        ind.className = 'typing-indicator'; 
        ind.style.display = 'flex';
        ind.innerHTML = '<div class="typing-dots"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>';

        row.appendChild(avatar); 
        row.appendChild(ind);
        this.chatMessages.appendChild(row);
        this.scrollToBottom();
      }

      hideTypingIndicator() {
        const typingMessage = document.getElementById('typing-message');
        if (typingMessage) {
          typingMessage.remove();
        }
        // Backup: Î±Ï†Î±Î¯ÏÎµÏƒÎ· ÏŒÎ»Ï‰Î½ Ï„Ï‰Î½ typing indicators
        this.chatMessages.querySelectorAll('.typing-indicator').forEach(ind => {
          const wrapper = ind.closest('.message.bot'); 
          (wrapper || ind).remove();
        });
      }

      showError(msg) {
        const d = document.createElement('div');
        d.className = 'error-message'; d.textContent = msg;
        this.chatMessages.appendChild(d);
        this.scrollToBottom();
        setTimeout(()=> d.remove(), 5000);
      }

      scrollToBottom() {
        setTimeout(()=> { this.chatMessages.scrollTop = this.chatMessages.scrollHeight; }, 50);
      }
    }

    // === Î¦ÎŸÎ¡Î¤Î©ÎœÎ‘ Î”Î•Î”ÎŸÎœÎ•ÎÎ©Î Î±Ï€ÏŒ sessionStorage ===
    function loadCompanyDataFromSession() {
      try {
        const raw = sessionStorage.getItem('companyData');
        console.log('ğŸ“Š companyData in sessionStorage:', !!raw);
        if (!raw) {
          // ÎÎ•ÎŸ: Î‘Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î±, ÏƒÏ„ÎµÎ¯Î»Îµ Î­Î½Î±Î½ Î²Î±ÏƒÎ¹ÎºÏŒ Ï‡Î±Î¹ÏÎµÏ„Î¹ÏƒÎ¼ÏŒ
          setTimeout(() => window.chatbot.sendAutomaticGreeting(), 1000);
          return;
        }

        const obj = JSON.parse(raw);
        const received = obj.received_data || {};
        const scraped  = obj.scraped || null;

        const infoForBackend = {
          companyName: received.companyName || 'AI Assistant',
          industry: received.industry || '',
          greeting: received.greeting || 'Î“ÎµÎ¹Î± ÏƒÎ±Ï‚! Î ÏÏ‚ Î¼Ï€Î¿ÏÏ Î½Î± Î²Î¿Î·Î¸Î®ÏƒÏ‰;',
          endMessage: received.endMessage || ''
        };

        // Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· UI + Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Ï€Î¿Ï… Î¸Î± ÏƒÏ„Î±Î»ÎµÎ¯ ÏƒÏ„Î¿ /chat
        window.chatbot.setCompanyInfo({
          name: infoForBackend.companyName,
          description: 'Î•Î¾Î±Ï„Î¿Î¼Î¹ÎºÎµÏ…Î¼Î­Î½Î¿Ï‚ Î²Î¿Î·Î¸ÏŒÏ‚',
          personality: 'Ï†Î¹Î»Î¹ÎºÏŒ ÎºÎ±Î¹ ÎµÏ€Î±Î³Î³ÎµÎ»Î¼Î±Ï„Î¹ÎºÏŒ ÏÏ†Î¿Ï‚',
          companyName: infoForBackend.companyName,
          industry: infoForBackend.industry,
          greeting: infoForBackend.greeting,
          endMessage: infoForBackend.endMessage
        });

        if (scraped && (scraped.text || scraped.title)) {
          window.chatbot.setWebsiteData(scraped);
          console.log('âœ… scraped loaded:', {
            text_len: (scraped.text || '').length,
            links: (scraped.links || []).length
          });
        } else {
          console.warn('âš ï¸ No scraped data present in session');
        }

        // Ï€ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬ flags (Î¼Î·Î½ ÏƒÏ„Î­Î»Î½ÎµÎ¹Ï‚ full_html Î±Î½ Î´ÎµÎ½ Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹)
        window.chatbot.setEvaluationContext({ include_full_html: false });
      } catch (e) {
        console.error('âŒ loadCompanyDataFromSession error:', e);
        // ÎÎ•ÎŸ: Î£Îµ Ï€ÎµÏÎ¯Ï€Ï„Ï‰ÏƒÎ· ÏƒÏ†Î¬Î»Î¼Î±Ï„Î¿Ï‚, ÏƒÏ„ÎµÎ¯Î»Îµ Î²Î±ÏƒÎ¹ÎºÏŒ Ï‡Î±Î¹ÏÎµÏ„Î¹ÏƒÎ¼ÏŒ
        setTimeout(() => window.chatbot.sendAutomaticGreeting(), 1000);
      }
    }

    // === BOOT: Ï†Ï„Î¹Î¬Î¾Îµ chatbot instance ÎºÎ±Î¹ Ï†ÏŒÏÏ„Ï‰ÏƒÎµ Î´ÎµÎ´Î¿Î¼Î­Î½Î± ===
    document.addEventListener('DOMContentLoaded', () => {
      window.chatbot = new Chatbot();
      loadCompanyDataFromSession();
    });
  </script>
</body>
</html>